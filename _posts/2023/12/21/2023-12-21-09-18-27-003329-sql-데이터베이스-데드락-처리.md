---
layout: post
title: "[sql] SQL 데이터베이스 데드락 처리"
description: " "
date: 2023-12-21
tags: [sql]
comments: true
share: true
---

데이터베이스 시스템에서 데드락은 두 개 이상의 트랜잭션이 상호 배제적인 락(lock)을 획득한 상태에서 서로의 락을 기다리는 상황을 의미합니다. 이는 데이터베이스 시스템의 성능을 저하시키고 시스템 전체의 안정성을 위협할 수 있습니다. SQL 데이터베이스에서 데드락을 처리하는 방법을 살펴봅시다.

## 1. 데드락이 발생하는 경우

일반적으로 데드락은 다음과 같은 상황에서 발생합니다.

- 트랜잭션 A가 테이블 X의 레코드를 갱신하고, 트랜잭션 B는 테이블 Y의 레코드를 갱신할 때
- 트랜잭션 A가 테이블 Y의 레코드를 읽고, 트랜잭션 B는 테이블 X의 레코드를 읽을 때

이러한 상황에서 트랜잭션들은 서로의 작업이 완료될 때까지 락을 유지하게 되고, 데드락이 발생할 수 있습니다.

## 2. 데드락 처리 방법

### 2.1. 락 타임아웃 설정

일부 데이터베이스 시스템은 데드락을 방지하기 위해 락 타임아웃 기능을 제공합니다. 이를 통해 락이 일정 시간 동안 유지되면 자동으로 해제되도록 설정할 수 있습니다.

```sql
SET innodb_lock_wait_timeout = 5;
```

### 2.2. 데드락 검출 및 해제

데이터베이스 시스템은 데드락을 검출하고, 필요에 따라 자동으로 데드락을 해제하는 기능을 제공합니다. 데드락을 검출하고 해제하는 방법은 데이터베이스 시스템에 따라 다를 수 있습니다.

### 2.3. 트랜잭션 재시도

일시적인 데드락이 발생할 경우, 해당 트랜잭션을 재시도함으로써 데드락을 해결할 수 있습니다.

## 3. 데드락 방지를 위한 권장 사항

- **최소한의 락 사용**: 트랜잭션에서 필요한 최소한의 레코드에만 락을 걸고 가능한 빨리 락을 해제하여 데드락 발생 가능성을 낮춥니다.
- **트랜잭션 크기 감소**: 긴 트랜잭션이 데드락을 발생시킬 가능성이 높으므로, 트랜잭션 크기를 감소시키는 것이 좋습니다.

## 요약

데이터베이스 데드락은 데이터베이스 시스템의 성능과 안정성을 위협하는 중요한 문제입니다. SQL 데이터베이스에서 데드락을 처리하고 방지하기 위해서는 락 타임아웃 설정, 데드락 검출 및 해제, 그리고 트랜잭션 재시도와 같은 방법을 활용할 수 있습니다. 데드락을 방지하기 위해서는 최소한의 락 사용과 트랜잭션 크기를 감소시키는 권장 사항을 준수하는 것이 좋습니다.

## 참고 자료
- [MySQL Documentation](https://dev.mysql.com/doc/refman/8.0/en/innodb-deadlocks.html)
- [SQL Server Documentation](https://docs.microsoft.com/en-us/sql/relational-databases/sql-server-compact/deadlocks?view=sql-server-ver15)