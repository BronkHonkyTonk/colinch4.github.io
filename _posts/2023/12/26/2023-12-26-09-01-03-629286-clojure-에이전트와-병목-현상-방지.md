---
layout: post
title: "[clojure] Clojure 에이전트와 병목 현상 방지"
description: " "
date: 2023-12-26
tags: [clojure]
comments: true
share: true
---

Clojure는 자유롭고 동시성이 뛰어나며 병행성이 있는 언어입니다. Clojure의 에이전트(agents)는 동시성을 다루기 위한 강력한 도구중 하나로, 공유 상태를 변경할 때 안전하게 동기화된 방식으로 사용할 수 있습니다. 하지만 잘못 사용하면 병목 현상을 일으키고 성능을 저하시킬 수 있습니다.

## 에이전트(agent)란 무엇인가요?

에이전트는 Clojure에서 상태를 변경하는 데 사용되는 추상화된 개념입니다. 에이전트는 불변적인 상태를 가진다는 특징을 가지고 있으며, 변경이 필요할 때마다 `send`나 `send-off` 함수를 사용하여 변경할 수 있습니다. 이러한 변경은 애플리케이션 상태를 변경하지 않으며, 에이전트가 관리하는 변경 내역은 큐에 저장됩니다. 이후 이러한 변경 내역들이 동기화된 방식으로 처리됩니다. 또한, 에이전트는 변경 내역을 순차적으로 처리하여 병목을 방지할 수 있습니다.

에이전트는 `send`와 `send-off` 함수를 사용하여 작업을 처리하며, **단 한 개의 변경 내역이 한 번에 실행되도록 보장**합니다. 이를 통해 공유된 상태에 대한 경쟁 조건을 방지할 수 있습니다.

에이전트를 사용하는 가장 큰 장점 중 하나는 **비동기적으로 작업을 처리**할 수 있다는 것입니다. 따라서 에이전트를 사용하면 병목을 방지하며, 동시성 문제를 해결할 수 있습니다.

에이전트의 동작 방식은 Clojure 런타임을 효율적으로 활용하여 변경 내역을 처리하므로 잘못 사용할 경우, **성능 문제가 발생할 수 있습니다**.

## 병목 현상 방지를 위한 에이전트 사용법

에이전트를 사용함으로써 병목 현상을 방지하려면, 다음과 같은 지침을 따라야 합니다.

### 1. 작업 단위를 분리하세요

처리할 작업을 작은 단위로 분리하여 여러 에이전트에 나눠 작업을 처리하세요. 이렇게 하면 여러 에이전트가 동시에 작업을 처리할 수 있으며, 락을 걸 필요가 없어 병목 현상을 방지할 수 있습니다.

```clojure
(defn process-data [data]
  (let [result (process-data-1 data)]
    (send-off processing-agent-1 result))
  (let [result (process-data-2 data)]
    (send-off processing-agent-2 result))
  ...)
```

### 2. 에이전트 풀 사용

에이전트 풀을 사용하여 동시에 여러 작업을 처리합니다. 이를 통해 여러 에이전트가 병렬적으로 작업을 처리하면서 상태 변화를 안전하게 다룰 수 있습니다.

```clojure
(def pool (agent-pool))
(defn process-data [data]
  (let [agent (get-free-agent pool)]
    (send agent process-fn data)))
```

### 3. 안전하게 상태 변경하기

에이전트를 사용하여 상태를 변경할 때는, **단일 변경 당 하나의 에이전트를 사용**하여 안전하게 실행되도록 보장해야 합니다. 또한, 에이전트 간의 종속성이 있는 경우 적절한 순서를 유지하여 병목을 방지해야 합니다.

에이전트를 올바르게 사용하면, 병목 현상을 방지하고 동시성을 쉽게 다룰 수 있습니다. Clojure의 에이전트는 안전하고 효율적으로 공유 상태를 관리하는 데에 있어 강력한 도구입니다.

참고문헌:
- [Clojure 에이전트 공식 문서](https://clojure.org/reference/agents)